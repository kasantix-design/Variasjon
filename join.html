<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Videomøte – Variasjon</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      margin: 0;
      background: #f0f4ff;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
    }
    .join-box {
      background: #fff;
      border-radius: 12px;
      padding: 2rem;
      box-shadow: 0 4px 20px rgba(0, 0, 0, .08);
      text-align: center;
      max-width: 400px;
      width: 100%;
    }
    input {
      width: 100%;
      padding: .6rem;
      border: 1px solid #ccc;
      border-radius: 6px;
      margin-top: .5rem;
      margin-bottom: 1rem;
    }
    button {
      padding: .6rem 1.2rem;
      font-weight: 600;
      border: none;
      border-radius: 8px;
      background: #3c74c9;
      color: #fff;
      cursor: pointer;
    }
    button:hover {
      filter: brightness(.95);
    }
    #room-container {
      display: none;
      flex-direction: column;
      width: 100%;
      height: 100%;
      padding: 1rem;
    }
    video {
      width: 100%;
      max-height: 80vh;
      border-radius: 12px;
      background: #000;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/livekit-client@2.1.0/dist/livekit-client.min.js"></script>
</head>

<body>
  <div class="join-box" id="join-box">
    <h1>Videomøte</h1>
    <p>Skriv inn navnet ditt for å bli med i møtet.</p>
    <input type="text" id="username" placeholder="Ditt navn" required />
    <button id="join-btn">Bli med</button>
    <p id="status"></p>
  </div>

  <div id="room-container">
    <video id="video-area" autoplay playsinline></video>
    <button id="leave-btn" style="margin-top:1rem;">Forlat møte</button>
  </div>

  <script>
    const { connect, RoomEvent } = window.LivekitClient;

    document.getElementById('join-btn').addEventListener('click', async () => {
      const name = document.getElementById('username').value.trim();
      if (!name) {
        alert("Skriv inn et navn først.");
        return;
      }

      const params = new URLSearchParams(window.location.search);
      const token = params.get('token');
      const url = decodeURIComponent(params.get('url') || '');
      const room = params.get('room') || 'coaching';

      if (!token || !url) {
        document.getElementById('status').textContent = "Mangler token eller server-url i lenken.";
        return;
      }

      try {
        document.getElementById('status').textContent = "Kobler til...";
        const roomConnection = await connect(url, token, { name });

        document.getElementById('join-box').style.display = "none";
        const container = document.getElementById('room-container');
        container.style.display = "flex";

        // Start lokal video
        await roomConnection.localParticipant.setCameraEnabled(true);

        // Vis andres video
        roomConnection.on(RoomEvent.TrackSubscribed, (_, publication, participant) => {
          const el = publication.track.attach();
          const oldEl = document.getElementById('video-area');
          oldEl.replaceWith(el);
          el.id = "video-area";
        });

        document.getElementById('leave-btn').onclick = () => {
          roomConnection.disconnect();
          location.href = "/admin.html";
        };
      } catch (err) {
        document.getElementById('status').textContent = "Kunne ikke koble til: " + err.message;
      }
    });
  </script>
</body>
</html>
