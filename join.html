<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Videomøte – Variasjon</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, sans-serif;
      margin: 0;
      background: #f0f4ff;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
    }
    .join-box, #room-container {
      background: #fff;
      border-radius: 12px;
      padding: 2rem;
      box-shadow: 0 4px 20px rgba(0,0,0,.08);
      max-width: 600px;
      width: 90%;
    }
    input, textarea {
      width: 100%;
      padding: .6rem;
      margin: .5rem 0;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    button {
      padding: .6rem 1.2rem;
      font-weight: 600;
      border: none;
      border-radius: 8px;
      background: #3c74c9;
      color: #fff;
      cursor: pointer;
      margin-right: 0.5rem;
      margin-top: 0.5rem;
    }
    button:hover {
      filter: brightness(.95);
    }
    video {
      width: 100%;
      border-radius: 12px;
      background: #000;
    }
    #chat-box {
      margin-top: 1rem;
      border-top: 1px solid #ccc;
      padding-top: 1rem;
    }
    #chat-messages {
      max-height: 150px;
      overflow-y: auto;
      margin-bottom: 1rem;
      font-size: 14px;
      background: #f9f9f9;
      padding: 0.5rem;
      border-radius: 6px;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/livekit-client@2.1.0/dist/livekit-client.min.js"></script>
</head>

<body>
  <div class="join-box" id="join-box">
    <h1>Videomøte</h1>
    <p>Skriv inn navnet ditt for å bli med i møtet.</p>
    <input type="text" id="username" placeholder="Ditt navn" required />
    <button id="join-btn">Bli med</button>
    <p id="status"></p>
  </div>

  <div id="room-container" style="display:none; flex-direction:column;">
    <video id="video-area" autoplay playsinline></video>
    <div>
      <button id="toggle-mic">Mute</button>
      <button id="leave-btn">Forlat møte</button>
    </div>

    <div id="chat-box">
      <h3>Chat</h3>
      <div id="chat-messages"></div>
      <input type="text" id="chat-input" placeholder="Skriv en melding..." />
      <button id="send-chat">Send</button>
    </div>
  </div>

  <script>
    const {
      connect,
      RoomEvent,
      ParticipantEvent,
      RemoteParticipant
    } = window.LivekitClient;

    let room;
    let micEnabled = true;

    document.getElementById('join-btn').addEventListener('click', async () => {
      const name = document.getElementById('username').value.trim();
      if (!name) return alert("Skriv inn et navn først.");

      const params = new URLSearchParams(window.location.search);
      const token = params.get('token');
      const url = decodeURIComponent(params.get('url') || '');
      const roomName = params.get('room') || 'coaching';

      if (!token || !url) {
        document.getElementById('status').textContent = "Mangler token eller server-url i lenken.";
        return;
      }

      try {
        document.getElementById('status').textContent = "Kobler til...";
        room = await connect(url, token, { name });

        // Vis rom og start kamera
        document.getElementById('join-box').style.display = "none";
        document.getElementById('room-container').style.display = "flex";

        await room.localParticipant.setCameraEnabled(true);
        await room.localParticipant.setMicrophoneEnabled(true);

        // Lokal video
        const videoEl = document.getElementById('video-area');
        room.localParticipant.videoTracks.forEach(pub => {
          const el = pub.track.attach();
          videoEl.replaceWith(el);
          el.id = "video-area";
        });

        // Mottar andres video
        room.on(RoomEvent.TrackSubscribed, (track, pub, participant) => {
          if (track.kind === 'video') {
            const el = track.attach();
            const old = document.getElementById('video-area');
            old.replaceWith(el);
            el.id = "video-area";
          }
        });

        // Chat (dataTrack)
        room.on(RoomEvent.DataReceived, (payload, participant) => {
          const msg = new TextDecoder().decode(payload);
          const chatEl = document.getElementById('chat-messages');
          const line = document.createElement('div');
          line.textContent = `${participant.name || "Deltaker"}: ${msg}`;
          chatEl.appendChild(line);
          chatEl.scrollTop = chatEl.scrollHeight;
        });

        // Leave
        document.getElementById('leave-btn').onclick = () => {
          room.disconnect();
          location.href = "/admin.html";
        };

        // Mute
        document.getElementById('toggle-mic').onclick = () => {
          micEnabled = !micEnabled;
          room.localParticipant.setMicrophoneEnabled(micEnabled);
          document.getElementById('toggle-mic').textContent = micEnabled ? "Mute" : "Unmute";
        };

        // Chat send
        document.getElementById('send-chat').onclick = () => {
          const msg = document.getElementById('chat-input').value.trim();
          if (!msg) return;
          room.localParticipant.publishData(msg, LivekitClient.DataPacket_Kind.RELIABLE);
          const chatEl = document.getElementById('chat-messages');
          const line = document.createElement('div');
          line.textContent = `Du: ${msg}`;
          chatEl.appendChild(line);
          chatEl.scrollTop = chatEl.scrollHeight;
          document.getElementById('chat-input').value = '';
        };

      } catch (err) {
        document.getElementById('status').textContent = "Kunne ikke koble til: " + err.message;
      }
    });
  </script>
</body>
</html>

